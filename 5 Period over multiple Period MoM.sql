SELECT
	SALES_MONTH,
	SALES,
	round((LAST1_YEAR_MONTH_SALES+LAST2_YEAR_MONTH_SALES+LAST3_YEAR_MONTH_SALES) / 3, 2) as avg_last_3_years,
	round(SALES / ((LAST1_YEAR_MONTH_SALES+LAST2_YEAR_MONTH_SALES+LAST3_YEAR_MONTH_SALES) / 3) - 1, 2) as pct_change
FROM
	(
		SELECT
			SALES_MONTH,
			SALES,
			--date_part('month', sales_month),
			/*LAG(SALES_MONTH) OVER (
			PARTITION BY
			DATE_PART('month', SALES_MONTH)
			ORDER BY
			SALES_MONTH
			) AS LAST_YEAR_MONTH,*/
			LAG(SALES) OVER (
				PARTITION BY
					DATE_PART('month', SALES_MONTH)
				ORDER BY
					SALES_MONTH
			) AS LAST1_YEAR_MONTH_SALES,
			LAG(SALES, 2) OVER (
				PARTITION BY
					DATE_PART('month', SALES_MONTH)
				ORDER BY
					SALES_MONTH
			) AS LAST2_YEAR_MONTH_SALES,
			LAG(SALES, 3) OVER (
				PARTITION BY
					DATE_PART('month', SALES_MONTH)
				ORDER BY
					SALES_MONTH
			) AS LAST3_YEAR_MONTH_SALES
			--sales - lag(sales) over (PARTITION by date_part('month', sales_month) order by sales_month) as abs_diff,
			--round((sales / lag(sales) over (PARTITION by date_part('month', sales_month) order by sales_month) -1), 3) *100 as MoLYM
		FROM
			RETAIL_SALES
		WHERE
			KIND_OF_BUSINESS = 'Book stores'
	)

--OR

SELECT
	SALES_MONTH,
	SALES,
	AVG(SALES) OVER (
		PARTITION BY
			DATE_PART('month', SALES_MONTH)
		ORDER BY
			SALES_MONTH ROWS BETWEEN 3 PRECEDING
			AND 1 PRECEDING
	) AS AVG_LAST_3_YEARS,
	(SALES / AVG(SALES) OVER (
		PARTITION BY
			DATE_PART('month', SALES_MONTH)
		ORDER BY
			SALES_MONTH ROWS BETWEEN 3 PRECEDING
			AND 1 PRECEDING
	)) - 1 AS PCT_CHANGE
FROM
	RETAIL_SALES
WHERE
	KIND_OF_BUSINESS = 'Book stores'

"sales_month"	"sales"	"avg_last_3_years"	"pct_change"
"1992-01-01"	790		
"1993-01-01"	998	  790.0000000000000000	0.2632911392405063
"1994-01-01"	1053	894.0000000000000000	0.1778523489932886
"1995-01-01"	1308	947.0000000000000000	0.3812038014783527
"1996-01-01"	1373	1119.6666666666666667	0.2262578148258410
